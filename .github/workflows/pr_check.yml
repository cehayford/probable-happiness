name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage
    
    - name: Check for migrations
      id: migration-check
      env:
        SECRET_KEY: 'test-secret-key-for-pr-checks'
        DEBUG: 'True'
        EMAIL_HOST_USER: 'test@example.com'
        EMAIL_HOST_PASSWORD: 'test-password'
        GOOGLE_OAUTH_CLIENT_ID: 'test-client-id'
        GOOGLE_OAUTH_CLIENT_SECRET: 'test-client-secret'
      run: |
        echo "checking_migrations=true" >> $GITHUB_OUTPUT
        if python manage.py makemigrations --check --dry-run; then
          echo "status=‚úÖ No pending migrations" >> $GITHUB_OUTPUT
          echo "migrations_needed=false" >> $GITHUB_OUTPUT
        else
          echo "status=‚ö†Ô∏è Migrations needed" >> $GITHUB_OUTPUT
          echo "migrations_needed=true" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Run Migrations
      env:
        SECRET_KEY: 'test-secret-key-for-pr-checks'
        DEBUG: 'True'
        EMAIL_HOST_USER: 'test@example.com'
        EMAIL_HOST_PASSWORD: 'test-password'
        GOOGLE_OAUTH_CLIENT_ID: 'test-client-id'
        GOOGLE_OAUTH_CLIENT_SECRET: 'test-client-secret'
      run: |
        python manage.py migrate
    
    - name: Run Tests with Coverage
      id: tests
      env:
        SECRET_KEY: 'test-secret-key-for-pr-checks'
        DEBUG: 'True'
        EMAIL_HOST_USER: 'test@example.com'
        EMAIL_HOST_PASSWORD: 'test-password'
        GOOGLE_OAUTH_CLIENT_ID: 'test-client-id'
        GOOGLE_OAUTH_CLIENT_SECRET: 'test-client-secret'
      run: |
        coverage run --source='.' manage.py test --verbosity=2
        coverage report > coverage.txt
        coverage html
        
        # Extract coverage percentage
        COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "test_status=‚úÖ Tests passed" >> $GITHUB_OUTPUT
      continue-on-error: true
    
    - name: Check Code Style
      id: style-check
      run: |
        pip install flake8 black isort
        
        # Check with flake8
        if flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics; then
          echo "flake8_status=‚úÖ No critical style issues" >> $GITHUB_OUTPUT
        else
          echo "flake8_status=‚ùå Critical style issues found" >> $GITHUB_OUTPUT
        fi
        
        # Check with black
        if black --check . 2>&1 | tee black_output.txt; then
          echo "black_status=‚úÖ Code is formatted correctly" >> $GITHUB_OUTPUT
        else
          echo "black_status=‚ö†Ô∏è Code needs formatting" >> $GITHUB_OUTPUT
        fi
        
        # Check with isort
        if isort --check-only . 2>&1 | tee isort_output.txt; then
          echo "isort_status=‚úÖ Imports are sorted correctly" >> $GITHUB_OUTPUT
        else
          echo "isort_status=‚ö†Ô∏è Imports need sorting" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Security Check
      id: security
      run: |
        pip install bandit safety
        
        # Run bandit
        if bandit -r . -x ./tests,./venv -f txt -o bandit_report.txt; then
          echo "bandit_status=‚úÖ No security issues found" >> $GITHUB_OUTPUT
        else
          echo "bandit_status=‚ö†Ô∏è Security issues detected" >> $GITHUB_OUTPUT
        fi
        
        # Run safety check
        if safety check --json > safety_report.json; then
          echo "safety_status=‚úÖ No vulnerable dependencies" >> $GITHUB_OUTPUT
        else
          echo "safety_status=‚ö†Ô∏è Vulnerable dependencies found" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Get changed files
      id: changed-files
      run: |
        FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.py$' | wc -l)
        echo "python_files=$FILES" >> $GITHUB_OUTPUT
    
    - name: Comment PR with Results
      uses: actions/github-script@v7
      if: always()
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const migrationStatus = '${{ steps.migration-check.outputs.status }}' || '‚è≠Ô∏è Skipped';
          const testStatus = '${{ steps.tests.outputs.test_status }}' || '‚ùå Tests failed';
          const coverage = '${{ steps.tests.outputs.coverage }}' || 'N/A';
          const flake8Status = '${{ steps.style-check.outputs.flake8_status }}' || '‚è≠Ô∏è Skipped';
          const blackStatus = '${{ steps.style-check.outputs.black_status }}' || '‚è≠Ô∏è Skipped';
          const isortStatus = '${{ steps.style-check.outputs.isort_status }}' || '‚è≠Ô∏è Skipped';
          const banditStatus = '${{ steps.security.outputs.bandit_status }}' || '‚è≠Ô∏è Skipped';
          const safetyStatus = '${{ steps.security.outputs.safety_status }}' || '‚è≠Ô∏è Skipped';
          const pythonFiles = '${{ steps.changed-files.outputs.python_files }}';
          
          const body = `## üîç Pull Request Check Results
          
          ### üìä Summary
          - **Python files changed:** ${pythonFiles}
          - **Test Coverage:** ${coverage}
          
          ### ‚úÖ Checks
          | Check | Status |
          |-------|--------|
          | Migrations | ${migrationStatus} |
          | Tests | ${testStatus} |
          | Flake8 (Critical) | ${flake8Status} |
          | Black (Formatting) | ${blackStatus} |
          | isort (Imports) | ${isortStatus} |
          | Bandit (Security) | ${banditStatus} |
          | Safety (Dependencies) | ${safetyStatus} |
          
          ---
          
          ${coverage !== 'N/A' && parseInt(coverage) < 80 ? '‚ö†Ô∏è **Warning:** Test coverage is below 80%' : ''}
          
          <sub>Automated checks completed for commit ${{ github.sha }}</sub>`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: coverage-report
        path: htmlcov/
    
    - name: Check if PR should be blocked
      if: steps.tests.outcome == 'failure' || steps.migration-check.outputs.migrations_needed == 'true'
      run: |
        echo "::error::PR checks failed. Please fix the issues before merging."
        exit 1